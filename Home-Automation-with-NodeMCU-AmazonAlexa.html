<html>
<head>
  <title>Evernote Export</title>
  <basefont face="Source Code Pro" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="Evernote Windows/309091 (en-US, DDL); Windows/10.0.0 (Win64);"/>
  <style>
    body, td {
      font-family: Source Code Pro;
      font-size: 12pt;
    }
  </style>
</head>
<body>
<a name="1832"/>
<h1>How To: DIY Home Automation With NodeMCU and Amazon Alexa : 13 Steps (with Pictures) - Instructables</h1>
<div>
<table bgcolor="#D4DDE5" border="0">
<tr><td><b>Created:</b></td><td><i>8/30/2020 9:22 PM</i></td></tr>
</table>
</div>
<br/>

<div><span>
  <div style="--en-clipped-content:simplified; --en-clipped-source-url:https://www.instructables.com/id/How-To-DIY-Home-Automation-With-NodeMCU-and-Amazon/; --en-clipped-source-title:How To: DIY Home Automation With NodeMCU and Amazon Alexa : 13 Steps (with Pictures) - Instructables;">
<div><br/></div><div style="font-size: 16px; display:block; min-width: 100%;"> <div style="background-color:transparent;font:inherit;vertical-align:baseline;"><div style="background-color:transparent;font:inherit;vertical-align:baseline;font-family:&quot;PT Serif&quot;;font-size:16px;line-height:1.5em;color:rgb(31, 9, 9);text-align:left;"><div style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;"><div style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;width:36em;z-index:200;padding-left:2em;padding-right:2em;margin-left:auto;margin-right:auto;position:relative;"><div style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;position:relative;margin-left:-25px;margin-right:25px;"><div style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;padding-top:0px;padding-bottom:9em;position:relative;"><div style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;margin-bottom:1.5em;"><div style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;position:relative;margin-bottom:0px;"><div style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;margin-bottom:0px;"><div style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;margin-bottom:0px;"><h1 style="font-family:&quot;PT Serif&quot;;text-align:left;border:0px;font:inherit;vertical-align:baseline;font-size:35px;font-weight:normal;line-height:35px;margin-bottom:20px;padding:0px;margin:0px;">How To: DIY Home Automation With NodeMCU and Amazon Alexa : 13 Steps (with Pictures)</h1><div style="padding:0px;border:0px;font:inherit;vertical-align:baseline;position:relative;height:1em;line-height:1;text-align:center;margin:0px;padding-top:1.5em;padding-bottom:1.5em;margin-bottom:0px;"><div style="padding:0px;border:0px;font:inherit;vertical-align:baseline;background:-webkit-linear-gradient(0deg, rgb(243, 242, 238) 1%, rgb(31, 9, 9) 50%, rgb(243, 242, 238) 99%);position:absolute;left:-4em;top:50%;z-index:10;width:100%;padding-left:4em;padding-right:4em;height:0.1em;opacity:0.5;margin:0px;margin-bottom:0px;"><span style="font:inherit;position:absolute;left:-4em;top:50%;z-index:10;width:100%;padding-left:4em;padding-right:4em;height:0.1em;margin:0px;opacity:0.5;background:-webkit-linear-gradient(0deg, rgb(243, 242, 238) 1%, rgb(31, 9, 9) 50%, rgb(243, 242, 238) 99%);"></span></div></div></div><h2 style="font-family:&quot;PT Serif&quot;;text-align:left;margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;font-weight:bold;font-size:30px;line-height:35px;margin-top:35px;margin-bottom:15px;">Step 12: The Code</h2><div style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;margin-bottom:1.5em;"><div style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;margin-bottom:0px;">
    <div style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;margin-bottom:0px;"><div style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;margin-bottom:0px;"><div style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;margin-bottom:0px;">
    <div style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;margin-bottom:0px;">
        
            <a href="https://cdn.instructables.com/ORIG/FGA/68FE/IZ6CAOPV/FGA68FEIZ6CAOPV.jpg?auto=webp&amp;frame=1&amp;width=1024&amp;height=1024&amp;fit=bounds&amp;md=b71c36ab4519187ada4ffccc0a431492" style="color:rgb(6, 85, 136);border:0px;font:inherit;vertical-align:baseline;text-decoration:none;display:block;background-color:transparent;margin:0px;padding:0px;" target="_blank">
                <div style="padding:0px;border:0px;font:inherit;vertical-align:baseline;display:block;text-align:center;margin-top:1em;margin:0px;margin-bottom:0px;"><img src="Home-Automation-with-NodeMCU-AmazonAlexa_files/FGA68FEIZ6CAOPV.jpg" type="image/jpeg" data-filename="FGA68FEIZ6CAOPV.jpg" height="325" style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;display:block;max-width:100%;" width="576"/></div>
                
            </a>
        
    </div>
</div></div></div>
</div></div><div style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;margin-bottom:0px;"><p style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;margin-bottom:1.5em;">I will not be sharing all of the files needed to get the NodeMCU up and running with Amazon Alexa here as it would be a lot of code. <strong style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;font-weight:bold;">Please </strong><a href="https://github.com/CharlesJGantt/NodeMCU-ESP8266-4-Channel-Relay-Board-Controlled-by-Amazon-Alexa" style="color:rgb(6, 85, 136);margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;text-decoration:none;" target="_blank"><strong style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;font-weight:bold;">visit my GitHub to download</strong></a><strong style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;font-weight:bold;"> a zip archive of all of the necessary files needed.</strong> Note that the code below will not compile, or upload without these additional files, so head over to my github to grab them all. </p><p style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;margin-bottom:1.5em;">I will share the main Arduino sketch that I used so that you can have an idea of how everything ties together. I won't break down the entire code, but I will point out that I am creating four callbacks with unique names, four switches with unique names, and four integers which define the relays. I am also defining four unique invocation names for Alexa to understand, which are mapped to separate ports on the web server, and each unique invocation name has two settings, On and Off.  </p><p style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;margin-bottom:1.5em;">Finally, I set the pinmode for each of the four relay pins as an output. Then it is as simple as setting up eight different functions for each relay. With the type of relay board I am using, I also have to set all four of the relay pins to a HIGH state in the setup code. This is necessary due to the way the coils are wired inside the relays that are used on the board. A HIGH signal turns the relays off, and a low signal turns them on.  </p><p style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;margin-bottom:1.5em;">For example, when Alexa hears the “Turn on lightOne” command, the ESP8266 on the NodeMCU runs the lightOneOn function.  There is a lot more that goes on with the code that handles the FauxMo Belkin WeMo emulation, and to be quite honest, I am not fully sure that I understand every aspect of it just yet. I do know that it works, and adding new devices (up to 14 is supported by WeMo and Alexa) is as easy as duplicating the things I mentioned above, and giving each new device a unique name. So without further ado, here is the Arduino sketch that makes the magic you saw in the video above work. Remember that this code is useless without the other five files that can be found on my Github repo for this project.  </p><p style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;margin-bottom:1.5em;">The LCD code and LCD hardware are completely optional and neither is required for this project to work. I included an LCD in the project for debugging / visual aid purposes only. If you do not wish to use an LCD in your project, simply comment out the LCD related code or remove it from the .ino file completely.  Note: If you run into any issues with the code not compiling, make sure that the full set of files, six in total, are opened in the Arduino IDE, and that the folder they are stored in is named exactly like the main .ino file. Some users have experienced issues due to the folder name and the .ino file name being different.<br/><br/>Note: This code will not compile or upload to your device without downloading the additional five files needed for the FauxMos code to work. <a href="https://github.com/CharlesJGantt/NodeMCU-ESP8266-4-Channel-Relay-Board-Controlled-by-Amazon-Alexa" style="color:rgb(6, 85, 136);margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;text-decoration:none;" target="_blank">Download that code from my GitHub by clicking here. </a></p><pre style="background-color:rgb(243, 242, 238);font-family:Inconsolata;margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;width:auto;font-size:0.875em;line-height:1.71429em;">/******************************************
   The unmodified version of this code is originally
   by kakopappa and can be found at <a href="http://bit.ly/2kKQiRg." style="color:rgb(6, 85, 136);margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;text-decoration:none;" target="_blank"> http://bit.ly/2kKQiRg.
</a>
   This version of the code has been modified by Charles Gantt
   and requires five additional files which can be found at <a href="http://bit.ly/2lRDwAJ" style="color:rgb(6, 85, 136);margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;text-decoration:none;" target="_blank"> http://bit.ly/2kKQiRg.
</a>
   Find out more about this project on Charles' website
   <a href="http://www.themakersworkbench.com/" style="color:rgb(6, 85, 136);margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;text-decoration:none;" target="_blank"> http://bit.ly/2kKQiRg.
</a>
   Follow Charles and TheMakersWorkbench on the following sites:
   YouTube: bit.ly/TMWB-on-YouTube
   TMWB on Facebook: bit.ly/TMWB-on-Facebook
   CJGanttMakes on Facebook: bit.ly/CJGanttMakes
   TMWB on Twitter: bit.ly/TMWB-on-Twitter
   Charles Gantt on Twitter: bit.ly/CJGanttOnTwitter
   Instructables: bit.ly/CJGanttOnInstructables
   TMWB Website: bit.ly/TheMakersWorkbench
   Charles Gantt on Element14: bit.ly/CJGantt-On-E14
   Charles Gantt on GitHub: bit.ly/CJGantt-on-Github
*/

#include &lt;ESP8266WiFi.h&gt;
#include &lt;ESP8266WebServer.h&gt;
#include &lt;WiFiUdp.h&gt;
#include &lt;functional&gt;
#include &quot;switch.h&quot;
#include &quot;UpnpBroadcastResponder.h&quot;
#include &quot;CallbackFunction.h&quot;
#include &lt;Wire.h&gt;
#include &lt;LiquidCrystal_I2C.h&gt;

// prototypes
boolean connectWifi();

//on/off callbacks
void lightOneOn();
void lightOneOff();
void lightTwoOn();
void lightTwoOff();
void outletOneOn();
void outletOneOff();
void outletTwoOn();
void outletTwoOff();

// Change this before you flash
const char* ssid = &quot;Skynet&quot;;
const char* password = &quot;8039795700&quot;;

boolean wifiConnected = false;

UpnpBroadcastResponder upnpBroadcastResponder;

Switch *lightOne = NULL;
Switch *lightTwo = NULL;
Switch *outletOne = NULL;
Switch *outletTwo = NULL;

// Set Relay Pins
int relayOne = 14;
int relayTwo = 15;
int relayThree = 03;
int relayFour = 01;

// Addr: 0x3F, 20 chars &amp; 4 lines. Sometimes display boards use address 0x27
LiquidCrystal_I2C lcd(0x3F, 4, 20); //Frentally display, use 0x3F if not working try 0x27

void setup()
{
  //Initalize LCD
  lcd.init();
  lcd.noBacklight();
  lcd.backlight();
  lcd.begin(20, 4);

  //Serial.begin(115200);

  // Initialise wifi connection
  wifiConnected = connectWifi();
  //Serial.print(&quot;WiFi Connected&quot;);

  if (wifiConnected) {
    upnpBroadcastResponder.beginUdpMulticast();

    // Show WiFi status on LCD along with SSID of network
    lcd.setCursor(0, 0);
    lcd.print(&quot;   WiFi Connected   &quot;);
    lcd.print(ssid);

    // Define your switches here. Max 14
    // Format: Alexa invocation name, local port no, on callback, off callback
    lightOne = new Switch(&quot;Light One&quot;, 80, lightOneOn, lightOneOff);
    lightTwo = new Switch(&quot;Light Two&quot;, 81, lightTwoOn, lightTwoOff);
    outletOne = new Switch(&quot;Outlet One&quot;, 82, outletOneOn, outletOneOff);
    outletTwo = new Switch(&quot;Outlet Two&quot;, 83, outletTwoOn, outletTwoOff);

    //Serial.println(&quot;Adding switches upnp broadcast responder&quot;);
    upnpBroadcastResponder.addDevice(*lightOne);
    upnpBroadcastResponder.addDevice(*lightTwo);
    upnpBroadcastResponder.addDevice(*outletOne);
    upnpBroadcastResponder.addDevice(*outletTwo);

    //Set relay pins to outputs
    pinMode(14, OUTPUT);
    pinMode(15, OUTPUT);
    pinMode(03, OUTPUT);
    pinMode(01, OUTPUT);

    //Create Polling Message
    lcd.clear();
    lcd.setCursor(0, 0);
    lcd.print(&quot;   Polling Status   &quot;);
    lcd.setCursor(0, 2);
    lcd.print(&quot;  Of Smart Devices  &quot;);
    delay(2000);

    //Set each relay pin to HIGH this display status messagefor each relay
    digitalWrite(relayOne, HIGH);   // sets relayOne on
    lcd.clear();
    lcd.print(&quot;Light  One: Off     &quot;);
    delay(500);
    digitalWrite(relayTwo, HIGH);   // sets relayOne on
    lcd.setCursor(0, 1);
    lcd.print(&quot;Light  Two: Off     &quot;);
    delay(500);
    digitalWrite(relayThree, HIGH);   // sets relayOne on
    lcd.setCursor(0, 2);
    lcd.print(&quot;Outlet One: Off     &quot;);
    delay(500);
    digitalWrite(relayFour, HIGH);   // sets relayOne on
    delay(500);
    lcd.setCursor(0, 3);
    lcd.print(&quot;Outlet Two: Off     &quot;);

    //Create system initialized message
    lcd.clear();
    lcd.setCursor(0, 0);
    delay(1000);
    lcd.print(&quot; System Initialzed  &quot;);
    delay(1000);
    lcd.setCursor(0, 2);
    lcd.print(&quot; Ready For Commands &quot;);
    delay(2000);

    //Set up device status message
    lcd.clear();
    lcd.print(&quot;Light  One: Off     &quot;);
    delay(500);
    lcd.setCursor(0, 1);
    lcd.print(&quot;Light  Two: Off     &quot;);
    delay(500);
    lcd.setCursor(0, 2);
    lcd.print(&quot;Outlet One: Off     &quot;);
    delay(500);
    lcd.setCursor(0, 3);
    lcd.print(&quot;Outlet Two: Off     &quot;);


  }
}

void loop()
{
  if (wifiConnected) {
    upnpBroadcastResponder.serverLoop();
    lightOne-&gt;serverLoop();
    lightTwo-&gt;serverLoop();
    outletOne-&gt;serverLoop();
    outletTwo-&gt;serverLoop();
  }
}

void lightOneOn() {
  // Serial.print(&quot;Switch 1 turn on ...&quot;);
  digitalWrite(relayOne, LOW);   // sets relayOne on
  lcd.setCursor(0, 0);
  lcd.print(&quot;Light  One: On      &quot;);
}

void lightOneOff() {
  // Serial.print(&quot;Switch 1 turn off ...&quot;);
  digitalWrite(relayOne, HIGH);   // sets relayOne off
  lcd.setCursor(0, 0);
  lcd.print(&quot;Light  One: Off     &quot;);
}

void lightTwoOn() {
  // Serial.print(&quot;Switch 2 turn on ...&quot;);
  digitalWrite(relayThree, LOW);   // sets relayTwo on
  lcd.setCursor(0, 1);
  lcd.print(&quot;Light  Two: On      &quot;);
}

void lightTwoOff() {
  // Serial.print(&quot;Switch 2 turn off ...&quot;);
  digitalWrite(relayThree, HIGH);   // sets relayTwo Off
  lcd.setCursor(0, 1);
  lcd.print(&quot;Light  Two: Off     &quot;);
}

//sockets

void outletOneOn() {
  //  Serial.print(&quot;Socket 1 turn on ...&quot;);
  digitalWrite(relayFour, LOW);   // sets relayThree on
  lcd.setCursor(0, 2);
  lcd.print(&quot;Outlet One: On      &quot;);
}

void outletOneOff() {
  // Serial.print(&quot;Socket 1 turn off ...&quot;);
  digitalWrite(relayFour, HIGH);   // sets relayThree off
  lcd.setCursor(0, 2);
  lcd.print(&quot;Outlet One: Off     &quot;);
}

void outletTwoOn() {
  // Serial.print(&quot;Socket 2 turn on ...&quot;);
  digitalWrite(relayTwo, LOW);   // sets relayFour on
  lcd.setCursor(0, 3);
  lcd.print(&quot;Outlet Two: On      &quot;);
}

void outletTwoOff() {
  // Serial.print(&quot;Socket 2 turn off ...&quot;);
  digitalWrite(relayTwo, HIGH);   // sets relayFour off
  lcd.setCursor(0, 3);
  lcd.print(&quot;Outlet Two: Off     &quot;);
}

// connect to wifi – returns true if successful or false if not
boolean connectWifi() {
  boolean state = true;
  int i = 0;

  WiFi.mode(WIFI_STA);
  WiFi.begin(ssid, password);
  Serial.println(&quot;&quot;);
  Serial.println(&quot;Connecting to WiFi&quot;);

  // Wait for connection
  // Serial.print(&quot;Connecting ...&quot;);
  while (WiFi.status() != WL_CONNECTED) {
    delay(500);
    //Serial.print(&quot;.&quot;);
    if (i &gt; 10) {
      state = false;
      break;
    }
    i++;
  }

  if (state) {
    //  Serial.println(&quot;&quot;);
    //  Serial.print(&quot;Connected to &quot;);
    //  Serial.println(ssid);
    // Serial.print(&quot;IP address: &quot;);
    //  Serial.println(WiFi.localIP());
  }
  else {
    // Serial.println(&quot;&quot;);
    //Serial.println(&quot;Connection failed.&quot;);
  }

  return state;
}
</pre></div></div></div></div></div></div></div></div></div></div></div>
</div>
</span>
</div></body></html> 